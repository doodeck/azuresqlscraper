# -*- coding: utf-8 -*-
"""nextbike-dataset-scraper.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1G33SwPaIGWFhbcUIz8b48kJatS8w2jfQ
"""

# This Python 3 environment comes with many helpful analytics libraries installed
# It is defined by the kaggle/python docker image: https://github.com/kaggle/docker-python
# For example, here's several helpful packages to load in 

import numpy as np # linear algebra
import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)

# Input data files are available in the "../input/" directory.
# For example, running this (by clicking run or pressing Shift+Enter) will list the files in the input directory

"""
import os
print(os.listdir("../input"))
"""

# Any results you write to the current directory are saved as output.

localfiles = [ "nextbike-live.json"] # "nextbike-live.xml", 
              # .xml seems to be obsolete: size is smaller but taking much longer to load
sqlitefile = "database.sqlite"
"""
for localfile in localfiles:
    !curl -o {localfile} "https://nextbike.net/maps/{localfile}"
!ls -ltra
"""

import json
import psutil

# interesting how much memory do we need for this kind of processing
print(psutil.virtual_memory())
with open(localfiles[0]) as f:
    nextbike_dict = json.load(f)
psutil.virtual_memory()

"""## Grope through the data structure"""

print(nextbike_dict.keys())
print(len(nextbike_dict['countries']))
# print(nextbike_dict['countries'][0])
# print(nextbike_dict['countries'][0]["cities"])
# print(nextbike_dict['countries'][0]["cities"][0]['places'])
# print(nextbike_dict['countries'][0]['cities'][0]['places'][0]['bike_list'])

"""## Create DB Tables"""

import sqlite3
conn = sqlite3.connect(sqlitefile) # , timeout=10)

c = conn.cursor()

c.execute('DROP TABLE IF EXISTS countries')
c.execute('DROP TABLE IF EXISTS cities')
c.execute('DROP TABLE IF EXISTS places')
c.execute('DROP TABLE IF EXISTS bike_list')

# coutries table
c.execute('''CREATE TABLE IF NOT EXISTS countries
             (
               guid INTEGER PRIMARY KEY AUTOINCREMENT,
               country VARCHAR(2),
               country_name TEXT,
               created INTEGER
               -- updated INTEGER
             )''')

# cities table
c.execute('''CREATE TABLE IF NOT EXISTS cities
             (
               guid INTEGER PRIMARY KEY AUTOINCREMENT,
               uid INTEGER,
               name TEXT,
               countryguid INTEGER,
               created INTEGER,
               -- updated INTEGER,
               FOREIGN KEY(countryguid) REFERENCES countries(guid)
             )''')

# places table
c.execute('''CREATE TABLE IF NOT EXISTS places
             (
               guid INTEGER PRIMARY KEY AUTOINCREMENT,
               uid INTEGER,
               name TEXT,
               cityguid INTEGER,
               created INTEGER,
               FOREIGN KEY(cityguid) REFERENCES cities(guid)
             )''')

# bike_list table
c.execute('''CREATE TABLE IF NOT EXISTS bike_list
             (
               guid INTEGER PRIMARY KEY AUTOINCREMENT,
               number INTEGER,
               placeguid INTEGER,
               created INTEGER,
               FOREIGN KEY(placeguid) REFERENCES places(guid)
             )''')

# Save (commit) the changes
conn.commit()


# We can also close the connection if we are done with it.
# Just be sure any changes have been committed or they will be lost.
conn.close()

"""## Transfer data from JSON/dict to DB"""

import time

conn = sqlite3.connect(sqlitefile)

c = conn.cursor()

for country in nextbike_dict['countries']:
    # print (country["country"], country["country_name"])
    # INSERT OR IGNORE INTO bookmarks(users_id, lessoninfo_id) VALUES(123, 456) ; INSERT OR REPLACE geht auch
    # c.execute("INSERT INTO countries VALUES (?,?,?,?)", (country["country"], country["country_name"],int(time.time()),0))
    c.execute('''INSERT INTO countries (country, country_name, created) SELECT ?,?,?
                 WHERE NOT EXISTS (SELECT 1 FROM countries WHERE country = ? AND country_name = ?)''',
              (country["country"], country["country_name"], int(time.time()),
               country["country"], country["country_name"]))
    currcountryguid = c.execute("SELECT guid FROM countries WHERE country = ? AND country_name = ?",
                                (country["country"], country["country_name"])).fetchone()[0] # SELECT last_insert_rowid(),
    # print (currcountryguid)
    # c.execute("UPDATE countries SET country = 'DP' WHERE country = 'DE'") # provoking changed entries for test purpose
    # print(country["cities"])
    for city in country['cities']:
        # print (city["uid"], city["name"])
        c.execute('''INSERT INTO cities (uid, name, countryguid, created) SELECT ?,?,?,?
                  WHERE NOT EXISTS (SELECT 1 FROM cities WHERE uid = ? AND name = ? AND countryguid = ?)''',
                  (city["uid"], city["name"], currcountryguid, int(time.time()),
                   city["uid"], city["name"], currcountryguid))
        # lastcityguid = c.execute("select seq from sqlite_sequence WHERE name = 'cities'").fetchone()[0]
        currcityguid = c.execute("SELECT guid FROM cities WHERE uid = ? AND name = ? AND countryguid = ?",
                                 (city["uid"], city["name"], currcountryguid)).fetchone()[0]
        # print(nextbike_dict['countries'][0]["cities"][0]['places'])
        for place in city['places']:
            # print (place['uid'], place['name'])
            c.execute('''INSERT INTO places (uid, name, cityguid, created) SELECT ?,?,?,?
                      WHERE NOT EXISTS (SELECT 1 FROM places WHERE uid = ? AND name = ? AND cityguid = ?)''',
                      (place["uid"], place["name"], currcityguid, int(time.time()),
                       place["uid"], place["name"], currcityguid))
            currplaceguid = c.execute("SELECT guid FROM places WHERE uid = ? AND name = ? AND cityguid = ?",
                                     (place["uid"], place["name"], currcityguid)).fetchone()[0]
            for bike in place['bike_list']:
                # print (bike['number'])
                # bikeuid = int(str(place['uid']) + str(bike['number'])) # Integers in Python 3 are of unlimited size. 
                c.execute('''INSERT INTO bike_list (number, placeguid, created) SELECT ?,?,?
                          WHERE NOT EXISTS (SELECT 1 FROM bike_list WHERE number = ? AND placeguid = ?)''',
                          (bike['number'], currplaceguid, int(time.time()),
                           bike['number'], currplaceguid))
conn.commit()
"""
for row in c.execute('SELECT * FROM countries ORDER BY country'):
  print (row)
for row in c.execute('SELECT * FROM cities ORDER BY countryguid, name'):
  print (row)
for row in c.execute('SELECT * FROM places ORDER BY cityguid, name'):
  print (row)
print (c.execute('''SELECT COUNT(DISTINCT c.country) AS Countries, COUNT (DISTINCT ct.uid) AS Cities, COUNT (DISTINCT p.uid) AS Places
                    FROM countries c, cities ct, places p''').fetchone())
for row in c.execute('SELECT * FROM bike_list ORDER BY placeguid, number'):
  print (row)
"""

print (c.execute('''SELECT (SELECT COUNT(guid) FROM countries ) AS Countries, 
                           (SELECT COUNT (guid) FROM cities) AS Cities,
                           (SELECT COUNT (guid) FROM places) AS Places,
                           (SELECT COUNT (guid) FROM bike_list) AS Bikes''').fetchone())

conn.close()

# !ls -ltra
